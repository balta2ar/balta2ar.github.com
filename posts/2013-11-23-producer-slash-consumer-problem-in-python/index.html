<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en-us">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Producer/Consumer problem in python | Mostly Technical</title>


<link rel="stylesheet" href="/css/style.css"/></head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://balta2ar.github.io/"><h1 class="title is-4">Mostly Technical</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"></nav>
      </div>
    </nav>

    
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle is-6 is-pulled-right">
      
    </div>
    <h2 class="subtitle is-6">November 23, 2013</h2>
    <h1 class="title">Producer/Consumer problem in python</h1>
    
    <div class="content">
      

<p>Recently I stumbled upon an almost classical <a href="http://en.wikipedia.org/wiki/Producer%E2%80%93consumer_problem">producer-consumer
problem</a> in my script. The script is very similar to the
popular <a href="http://s3tools.org/s3cmd">s3cmd</a> &ndash; it syncronises contents of the local and remote
folder. Direction doesn&rsquo;t matter but for the clarity let&rsquo;s pretend it downloads
data from the remote side.</p>

<!--
Recently I stumbled upon an almost classical [producer-consumer
problem][producer-consumer] in my script. The script is very similar to the
popular [s3cmd][s3cmd] - it syncronises contents of the local and [S3][s3]
folder. Direction doesn't matter but for the clarity let's pretend it downloads
data from S3. Of course I could take s3cmd from an [alternative][s3cmdparallel1]
[github][s3cmdparallel2] repo where parallel workers feature is already
implemented (there is an [issue][issue] in s3cmd to implement that). However,
for some reason, I needed my very own version of such parallel downloader.
-->

<!-- more -->

<p>In this post I would like to tell a story of my progress implementing this
feature, share some bugs I found and workarounds I had to use. First, let me
describe the directory structure. It is rather strict and looks like this:</p>

<pre><code>$ tree /home/bz/source 
/home/bz/source
├── apple
│   ├── 2013-11-22
│   │   ├── apple-2013-11-22-0.tsv.gz
│   │   └── apple-2013-11-22-1.tsv.gz
│   ├── 2013-11-23
│   │   ├── apple-2013-11-23-0.tsv.gz
│   │   └── apple-2013-11-23-1.tsv.gz
│   ├── _description
│   └── _header
├── banana
│   ├── 2013-11-22
│   │   ├── banana-2013-11-22-0.tsv.gz
│   │   └── banana-2013-11-22-1.tsv.gz
│   ├── 2013-11-23
│   │   ├── banana-2013-11-23-0.tsv.gz
│   │   └── banana-2013-11-23-1.tsv.gz
│   ├── _description
│   └── _header
└── orange
    ├── 2013-11-22
    │   ├── orange-2013-11-22-0.tsv.gz
    │   └── orange-2013-11-22-1.tsv.gz
    ├── 2013-11-23
    │   ├── orange-2013-11-23-0.tsv.gz
    │   └── orange-2013-11-23-1.tsv.gz
    ├── _description
    └── _header

9 directories, 18 files
</code></pre>

<h3 id="first-try">First try</h3>

<p>Let&rsquo;s start with a very basic non-parallel sketch of such downloader. I will
use python2 because of the dependencies I have in my original script.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">os</span>
<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">sys</span>
<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">time</span>
<span style="color:#007020;font-weight:bold">import</span> <span style="color:#0e84b5;font-weight:bold">random</span>
<span style="color:#007020;font-weight:bold">from</span> <span style="color:#0e84b5;font-weight:bold">os.path</span> <span style="color:#007020;font-weight:bold">import</span> join <span style="color:#007020;font-weight:bold">as</span> J


<span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">delay</span>(ms, delta<span style="color:#666">=</span><span style="color:#40a070">500</span>):
    wait <span style="color:#666">=</span> ms <span style="color:#666">+</span> random<span style="color:#666">.</span>randrange(delta) <span style="color:#666">/</span> <span style="color:#40a070">1000.0</span>
    time<span style="color:#666">.</span>sleep(wait)


<span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">RemoteFilesystem</span>(<span style="color:#007020">object</span>):
    <span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">File</span>(<span style="color:#007020">object</span>):
        <span style="color:#007020;font-weight:bold">def</span> __init__(self, name, filetype):
            self<span style="color:#666">.</span>name <span style="color:#666">=</span> name
            self<span style="color:#666">.</span>filetype <span style="color:#666">=</span> filetype

        <span style="color:#007020;font-weight:bold">def</span> __repr__(self):
            <span style="color:#007020;font-weight:bold">return</span> <span style="color:#4070a0">&#39;{0}_{1}&#39;</span><span style="color:#666">.</span>format(self<span style="color:#666">.</span>name, self<span style="color:#666">.</span>filetype)

    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">list</span>(self, path):
        delay(<span style="color:#40a070">1</span>, <span style="color:#40a070">500</span>)
        items <span style="color:#666">=</span> []
        <span style="color:#007020;font-weight:bold">for</span> x <span style="color:#007020;font-weight:bold">in</span> os<span style="color:#666">.</span>listdir(path):
            typ <span style="color:#666">=</span> <span style="color:#4070a0">&#39;file&#39;</span> <span style="color:#007020;font-weight:bold">if</span> os<span style="color:#666">.</span>path<span style="color:#666">.</span>isfile(os<span style="color:#666">.</span>path<span style="color:#666">.</span>join(path, x)) <span style="color:#007020;font-weight:bold">else</span> <span style="color:#4070a0">&#39;dir&#39;</span>
            items<span style="color:#666">.</span>append(RemoteFilesystem<span style="color:#666">.</span>File(x, typ))
        <span style="color:#007020;font-weight:bold">return</span> items

    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">download_to</span>(self, source, dest):
        <span style="color:#007020;font-weight:bold">print</span>(<span style="color:#4070a0">&#39;Downloading {0}&#39;</span><span style="color:#666">.</span>format(source))
        delay(<span style="color:#40a070">0</span>, <span style="color:#40a070">500</span>)
        <span style="color:#007020;font-weight:bold">try</span>:
            os<span style="color:#666">.</span>makedirs(os<span style="color:#666">.</span>path<span style="color:#666">.</span>dirname(dest))
        <span style="color:#007020;font-weight:bold">except</span> <span style="color:#007020">OSError</span>:
            <span style="color:#007020;font-weight:bold">pass</span>
        <span style="color:#007020;font-weight:bold">with</span> <span style="color:#007020">open</span>(dest, <span style="color:#4070a0">&#39;w&#39;</span>) <span style="color:#007020;font-weight:bold">as</span> fdest:
            fdest<span style="color:#666">.</span>write(<span style="color:#007020">open</span>(source)<span style="color:#666">.</span>read())


<span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">sync</span>(source, dest):
    <span style="color:#007020;font-weight:bold">print</span>(<span style="color:#4070a0">&#39;Scanning dir {0}&#39;</span><span style="color:#666">.</span>format(source))
    remote <span style="color:#666">=</span> RemoteFilesystem()
    files <span style="color:#666">=</span> remote<span style="color:#666">.</span><span style="color:#007020">list</span>(source)
    <span style="color:#007020;font-weight:bold">for</span> x <span style="color:#007020;font-weight:bold">in</span> files:
        snext, dnext <span style="color:#666">=</span> J(source, x<span style="color:#666">.</span>name), J(dest, x<span style="color:#666">.</span>name)
        <span style="color:#007020;font-weight:bold">if</span> x<span style="color:#666">.</span>filetype <span style="color:#666">==</span> <span style="color:#4070a0">&#39;file&#39;</span>:
            remote<span style="color:#666">.</span>download_to(snext, dnext)
        <span style="color:#007020;font-weight:bold">else</span>:
            sync(snext, dnext)


<span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">main</span>():
    source, dest <span style="color:#666">=</span> sys<span style="color:#666">.</span>argv[<span style="color:#40a070">1</span>:<span style="color:#40a070">3</span>]
    sync(source, dest)

<span style="color:#007020;font-weight:bold">if</span> __name__ <span style="color:#666">==</span> <span style="color:#4070a0">&#39;__main__&#39;</span>:
    random<span style="color:#666">.</span>seed()
    main()</code></pre></div>
<p><strong>Link to github.</strong></p>

<p>I intentionally keep the number of error checks at minimum to not to distract
you with non-related details. To simulate delays (connection establishment, data
transfer) in the original remote system I added artificial random delays. Let&rsquo;s
run our script and see how fast it works:</p>

<pre><code>$ time python2 sync.py /home/bz/source dest
Scanning dir /home/bz/source
Scanning dir /home/bz/source/banana
Downloading /home/bz/source/banana/_header
Downloading /home/bz/source/banana/_description
Scanning dir /home/bz/source/banana/2013-11-23
Downloading /home/bz/source/banana/2013-11-23/banana-2013-11-23-1.tsv.gz
Downloading /home/bz/source/banana/2013-11-23/banana-2013-11-23-0.tsv.gz
Scanning dir /home/bz/source/banana/2013-11-22
Downloading /home/bz/source/banana/2013-11-22/banana-2013-11-22-0.tsv.gz
Downloading /home/bz/source/banana/2013-11-22/banana-2013-11-22-1.tsv.gz
Scanning dir /home/bz/source/orange
Downloading /home/bz/source/orange/_header
Downloading /home/bz/source/orange/_description
Scanning dir /home/bz/source/orange/2013-11-23
Downloading /home/bz/source/orange/2013-11-23/orange-2013-11-23-1.tsv.gz
Downloading /home/bz/source/orange/2013-11-23/orange-2013-11-23-0.tsv.gz
Scanning dir /home/bz/source/orange/2013-11-22
Downloading /home/bz/source/orange/2013-11-22/orange-2013-11-22-1.tsv.gz
Downloading /home/bz/source/orange/2013-11-22/orange-2013-11-22-0.tsv.gz
Scanning dir /home/bz/source/apple
Downloading /home/bz/source/apple/_header
Downloading /home/bz/source/apple/_description
Scanning dir /home/bz/source/apple/2013-11-23
Downloading /home/bz/source/apple/2013-11-23/apple-2013-11-23-1.tsv.gz
Downloading /home/bz/source/apple/2013-11-23/apple-2013-11-23-0.tsv.gz
Scanning dir /home/bz/source/apple/2013-11-22
Downloading /home/bz/source/apple/2013-11-22/apple-2013-11-22-0.tsv.gz
Downloading /home/bz/source/apple/2013-11-22/apple-2013-11-22-1.tsv.gz
python2 sync.py /home/bz/source dest  0.02s user 0.02s system 0% cpu 16.172 total
</code></pre>

<p>Not very fast indeed. We definitely can reduce total running time if we run the
sync in parallel. In my first try I decided to use thread-safe Queue module.  My
idea was to run directory listing in workers instead of the main thread. To do
this, instead of listing the directory immediately I put listing request into
the queue. I quickly realized that this model is not quite a traditionally
explained producer-consumer model. In a classic producer-consumer model
producers and consumers are different entities (even though there might be many
of each). This means that producer will never consume an item and vise versa.
In my case, however, it was not true.</p>

<p>When another directory is listed, it might return a list of files which will be
downloaded in the same thread. However it might also return a list of
subdirectories which will be added to the queue to scan later, possibly in a
different worker. Thus, the very first method which starts the syncronization
doesn&rsquo;t really know in advance what files and directories there will be and it
doesn&rsquo;t know when to stop processing. In my case consumer can produce more work
and we don&rsquo;t know if it happens in advance.</p>

<h3 id="parallel-try">Parallel try</h3>

<p>Here is a new parallel version startup method. It creates a <code>queue</code>,
<code>long_running_items_left</code> counter of the currently running directory listings and a
global signal <code>transfer_done</code>:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">sync</span>(self, source, dest):
    self<span style="color:#666">.</span>queue <span style="color:#666">=</span> Queue<span style="color:#666">.</span>Queue()
    self<span style="color:#666">.</span>transfer_done <span style="color:#666">=</span> threading<span style="color:#666">.</span>Event()
    self<span style="color:#666">.</span>long_running_items_left <span style="color:#666">=</span> Counter(<span style="color:#40a070">1</span>)
    N <span style="color:#666">=</span> <span style="color:#40a070">5</span>

    <span style="color:#007020;font-weight:bold">for</span> i <span style="color:#007020;font-weight:bold">in</span> <span style="color:#007020">range</span>(N):
        t <span style="color:#666">=</span> threading<span style="color:#666">.</span>Thread(target<span style="color:#666">=</span>self<span style="color:#666">.</span>sync_worker)
        t<span style="color:#666">.</span>daemon <span style="color:#666">=</span> True
        t<span style="color:#666">.</span>start()

    self<span style="color:#666">.</span>sync_dir(source, dest)

    self<span style="color:#666">.</span>transfer_done<span style="color:#666">.</span><span style="color:#007020">set</span>()
    <span style="color:#007020;font-weight:bold">while</span> threading<span style="color:#666">.</span>active_count() <span style="color:#666">&gt;</span> <span style="color:#40a070">1</span>:
        time<span style="color:#666">.</span>sleep(<span style="color:#40a070">0.1</span>)

    self<span style="color:#666">.</span>queue<span style="color:#666">.</span>join()</code></pre></div>
<p>As you can see, <code>join()</code> is not used to wait for the queue to drain. Instead,
<code>threading.active_count()</code> is used to check the number currently running
threads. First time I saw this hack in s3cmd <a href="https://github.com/pcorliss/s3cmd-modification/commit/9a65f78ea9e2a6633558a9462dc285c9ce1d943a#diff-c2214fd9d0677e2abe4e25e9a8950a2cR72">parallel</a>
patch. It says:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#60a0b0;font-style:italic">#Necessary to ensure KeyboardInterrupt can actually kill</span>
    <span style="color:#60a0b0;font-style:italic">#Otherwise Queue.join() blocks until all queue elements have completed</span>
    <span style="color:#007020;font-weight:bold">while</span> threading<span style="color:#666">.</span>active_count() <span style="color:#666">&gt;</span> <span style="color:#40a070">1</span>:
        time<span style="color:#666">.</span>sleep(<span style="color:#666">.</span><span style="color:#40a070">1</span>)</code></pre></div>
<p>I didn&rsquo;t know at the moment why it was necessary and why would <code>join()</code> ignore
<code>KeyboardInterrupt</code> so I just copy-pasted it. Because of this hacky way to join
we now need to make sure that workers know when to die. In my case they need
to busy-loop waiting for the queue to fill with something and when they know
for sure that there will be no more work, worker should terminate.</p>

<p>This appeared to be tricky. How does a worker know when to terminate? To give
worker this knowledge, I introduced two new variables:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">self<span style="color:#666">.</span>transfer_done <span style="color:#666">=</span> threading<span style="color:#666">.</span>Event()
self<span style="color:#666">.</span>long_running_items_left <span style="color:#666">=</span> Counter(<span style="color:#40a070">1</span>)</code></pre></div>
<p><code>transfer_done</code> is a global event. It is cleared before the first call to
<code>sync_dir</code> and it is set before waiting for the number of active threads to go
down to one.</p>

<p><code>long_running_items_left</code> is a thread-safe counter. It is incemented
before <code>list_dir</code> and is decremented when <code>list_dir</code> is done. This counter
represents the number currently listing directories. The need for such counter
can be demonstrated in an example: suppose we&rsquo;re running 10 workers. We list
the first directory and a list of three subdirectories is returned. Three items
are added to the queue and they all are soon taken by three different workers.
However, the rest of the workers, seven of them, they try to get work from the
queue but it&rsquo;s empty. The worker can&rsquo;t tell if it&rsquo;s OK to die only by observing
the queue. We know that at the very moment there are three other workers
listing some directories and we need to provide this information to other
workers so that they don&rsquo;t terminate prematurely.</p>

<p>Also, because <code>sync_dir</code> is called in the startup method, the counter is
initialized with value 1:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">self<span style="color:#666">.</span>long_running_items_left <span style="color:#666">=</span> Counter(<span style="color:#40a070">1</span>)</code></pre></div>
<p><code>Counter</code> is a simple thread-safe counter guarded with <code>threading.Lock</code>. I
couldn&rsquo;t find anything similar in the <code>threading</code> module so I invented my own:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Counter</span>(<span style="color:#007020">object</span>):
    <span style="color:#007020;font-weight:bold">def</span> __init__(self, initval<span style="color:#666">=</span><span style="color:#40a070">0</span>):
        self<span style="color:#666">.</span>val <span style="color:#666">=</span> initval
        self<span style="color:#666">.</span>lock <span style="color:#666">=</span> threading<span style="color:#666">.</span>Lock()

    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">inc</span>(self, n<span style="color:#666">=</span><span style="color:#40a070">1</span>):
        <span style="color:#007020;font-weight:bold">with</span> self<span style="color:#666">.</span>lock:
            self<span style="color:#666">.</span>val <span style="color:#666">+=</span> n
            <span style="color:#007020;font-weight:bold">return</span> self<span style="color:#666">.</span>val

    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">dec</span>(self, n<span style="color:#666">=</span><span style="color:#40a070">1</span>):
        <span style="color:#007020;font-weight:bold">with</span> self<span style="color:#666">.</span>lock:
            self<span style="color:#666">.</span>val <span style="color:#666">-=</span> n
            <span style="color:#007020;font-weight:bold">return</span> self<span style="color:#666">.</span>val

    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">value</span>(self):
        <span style="color:#007020;font-weight:bold">with</span> self<span style="color:#666">.</span>lock:
            <span style="color:#007020;font-weight:bold">return</span> self<span style="color:#666">.</span>val</code></pre></div>
<p>Now when <code>sync_dir</code> sees another directory it will enqueue it instead of
immediate listing:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">sync_dir</span>(self, source, dest):
    <span style="color:#007020;font-weight:bold">print</span>(<span style="color:#4070a0">&#39;Scanning dir {0}&#39;</span><span style="color:#666">.</span>format(source))
    remote <span style="color:#666">=</span> RemoteFilesystem()
    files <span style="color:#666">=</span> remote<span style="color:#666">.</span><span style="color:#007020">list</span>(source)
    <span style="color:#007020;font-weight:bold">for</span> x <span style="color:#007020;font-weight:bold">in</span> files:
        snext, dnext <span style="color:#666">=</span> J(source, x<span style="color:#666">.</span>name), J(dest, x<span style="color:#666">.</span>name)
        <span style="color:#007020;font-weight:bold">if</span> x<span style="color:#666">.</span>filetype <span style="color:#666">==</span> <span style="color:#4070a0">&#39;file&#39;</span>:
            self<span style="color:#666">.</span>download(snext, dnext)
        <span style="color:#007020;font-weight:bold">else</span>:
            self<span style="color:#666">.</span>long_running_items_left<span style="color:#666">.</span>inc()
            self<span style="color:#666">.</span>queue<span style="color:#666">.</span>put((self<span style="color:#666">.</span>sync_dir, [snext, dnext]))
    self<span style="color:#666">.</span>long_running_items_left<span style="color:#666">.</span>dec()</code></pre></div>
<p><code>sync_worker</code> is executed by every worker. In this method we request another
piece of work from the queue and try to process it. As I mentioned before,
empty queue doesn&rsquo;t necessarily mean we can terminate. That&rsquo;s why we also
check <code>transfer_done</code> and <code>long_running_items_left</code>. If we extracted and successfully
processed a work, we mark task as done.</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">sync_worker</span>(self):
    <span style="color:#007020;font-weight:bold">while</span> True:
        <span style="color:#007020;font-weight:bold">try</span>:
            handler, args <span style="color:#666">=</span> self<span style="color:#666">.</span>queue<span style="color:#666">.</span>get_nowait()
            handler(<span style="color:#666">*</span>args)
        <span style="color:#007020;font-weight:bold">except</span> Queue<span style="color:#666">.</span>Empty:
            <span style="color:#007020;font-weight:bold">if</span> self<span style="color:#666">.</span>transfer_done<span style="color:#666">.</span>is_set() <span style="color:#007020;font-weight:bold">and</span> (self<span style="color:#666">.</span>long_running_items_left<span style="color:#666">.</span>value() <span style="color:#666">==</span> <span style="color:#40a070">0</span>):
                <span style="color:#007020;font-weight:bold">print</span>(<span style="color:#4070a0">&#39;QUEUE IS EMPTY AND WE ARE DONE&#39;</span>)
                <span style="color:#007020;font-weight:bold">return</span>
            <span style="color:#007020;font-weight:bold">else</span>:
                <span style="color:#007020;font-weight:bold">print</span>(<span style="color:#4070a0">&#39;QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING&#39;</span>)
                time<span style="color:#666">.</span>sleep(<span style="color:#40a070">1.0</span>)
                <span style="color:#007020;font-weight:bold">continue</span>
        <span style="color:#007020;font-weight:bold">except</span> <span style="color:#007020">Exception</span> <span style="color:#007020;font-weight:bold">as</span> e:
            <span style="color:#007020;font-weight:bold">print</span>(<span style="color:#4070a0">&#39;EXCEPTION IN WORKER: {0}&#39;</span><span style="color:#666">.</span>format(e))
        self<span style="color:#666">.</span>queue<span style="color:#666">.</span>task_done()</code></pre></div>
<p>Here is a complete code in one piece (I also restructured the code a bit, moved
all syncer methods into the same class):</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Counter</span>(<span style="color:#007020">object</span>):
    <span style="color:#007020;font-weight:bold">def</span> __init__(self, initval<span style="color:#666">=</span><span style="color:#40a070">0</span>):
        self<span style="color:#666">.</span>val <span style="color:#666">=</span> initval
        self<span style="color:#666">.</span>lock <span style="color:#666">=</span> threading<span style="color:#666">.</span>Lock()

    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">inc</span>(self, n<span style="color:#666">=</span><span style="color:#40a070">1</span>):
        <span style="color:#007020;font-weight:bold">with</span> self<span style="color:#666">.</span>lock:
            self<span style="color:#666">.</span>val <span style="color:#666">+=</span> n
            <span style="color:#007020;font-weight:bold">return</span> self<span style="color:#666">.</span>val

    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">dec</span>(self, n<span style="color:#666">=</span><span style="color:#40a070">1</span>):
        <span style="color:#007020;font-weight:bold">with</span> self<span style="color:#666">.</span>lock:
            self<span style="color:#666">.</span>val <span style="color:#666">-=</span> n
            <span style="color:#007020;font-weight:bold">return</span> self<span style="color:#666">.</span>val

    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">value</span>(self):
        <span style="color:#007020;font-weight:bold">with</span> self<span style="color:#666">.</span>lock:
            <span style="color:#007020;font-weight:bold">return</span> self<span style="color:#666">.</span>val


<span style="color:#007020;font-weight:bold">class</span> <span style="color:#0e84b5;font-weight:bold">Syncer</span>(<span style="color:#007020">object</span>):
    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">sync</span>(self, source, dest):
        self<span style="color:#666">.</span>queue <span style="color:#666">=</span> Queue<span style="color:#666">.</span>Queue()
        self<span style="color:#666">.</span>transfer_done <span style="color:#666">=</span> threading<span style="color:#666">.</span>Event()
        self<span style="color:#666">.</span>long_running_items_left <span style="color:#666">=</span> Counter(<span style="color:#40a070">1</span>)
        N <span style="color:#666">=</span> <span style="color:#40a070">5</span>

        <span style="color:#007020;font-weight:bold">for</span> i <span style="color:#007020;font-weight:bold">in</span> <span style="color:#007020">range</span>(N):
            t <span style="color:#666">=</span> threading<span style="color:#666">.</span>Thread(target<span style="color:#666">=</span>self<span style="color:#666">.</span>sync_worker)
            t<span style="color:#666">.</span>daemon <span style="color:#666">=</span> True
            t<span style="color:#666">.</span>start()

        self<span style="color:#666">.</span>sync_dir(source, dest)

        self<span style="color:#666">.</span>transfer_done<span style="color:#666">.</span><span style="color:#007020">set</span>()
        <span style="color:#007020;font-weight:bold">while</span> threading<span style="color:#666">.</span>active_count() <span style="color:#666">&gt;</span> <span style="color:#40a070">1</span>:
            time<span style="color:#666">.</span>sleep(<span style="color:#40a070">0.1</span>)

        self<span style="color:#666">.</span>queue<span style="color:#666">.</span>join()

    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">sync_worker</span>(self):
        <span style="color:#007020;font-weight:bold">while</span> True:
            <span style="color:#007020;font-weight:bold">try</span>:
                handler, args <span style="color:#666">=</span> self<span style="color:#666">.</span>queue<span style="color:#666">.</span>get_nowait()
                handler(<span style="color:#666">*</span>args)
            <span style="color:#007020;font-weight:bold">except</span> Queue<span style="color:#666">.</span>Empty:
                <span style="color:#007020;font-weight:bold">if</span> self<span style="color:#666">.</span>transfer_done<span style="color:#666">.</span>is_set() <span style="color:#007020;font-weight:bold">and</span> (self<span style="color:#666">.</span>long_running_items_left<span style="color:#666">.</span>value() <span style="color:#666">==</span> <span style="color:#40a070">0</span>):
                    <span style="color:#007020;font-weight:bold">print</span>(<span style="color:#4070a0">&#39;QUEUE IS EMPTY AND WE ARE DONE&#39;</span>)
                    <span style="color:#007020;font-weight:bold">return</span>
                <span style="color:#007020;font-weight:bold">else</span>:
                    <span style="color:#007020;font-weight:bold">print</span>(<span style="color:#4070a0">&#39;QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING&#39;</span>)
                    time<span style="color:#666">.</span>sleep(<span style="color:#40a070">1.0</span>)
                    <span style="color:#007020;font-weight:bold">continue</span>
            <span style="color:#007020;font-weight:bold">except</span> <span style="color:#007020">Exception</span> <span style="color:#007020;font-weight:bold">as</span> e:
                <span style="color:#007020;font-weight:bold">print</span>(<span style="color:#4070a0">&#39;EXCEPTION IN WORKER: {0}&#39;</span><span style="color:#666">.</span>format(e))
            self<span style="color:#666">.</span>queue<span style="color:#666">.</span>task_done()

    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">sync_dir</span>(self, source, dest):
        <span style="color:#007020;font-weight:bold">print</span>(<span style="color:#4070a0">&#39;Scanning dir {0}&#39;</span><span style="color:#666">.</span>format(source))
        remote <span style="color:#666">=</span> RemoteFilesystem()
        files <span style="color:#666">=</span> remote<span style="color:#666">.</span><span style="color:#007020">list</span>(source)
        <span style="color:#007020;font-weight:bold">for</span> x <span style="color:#007020;font-weight:bold">in</span> files:
            snext, dnext <span style="color:#666">=</span> J(source, x<span style="color:#666">.</span>name), J(dest, x<span style="color:#666">.</span>name)
            <span style="color:#007020;font-weight:bold">if</span> x<span style="color:#666">.</span>filetype <span style="color:#666">==</span> <span style="color:#4070a0">&#39;file&#39;</span>:
                self<span style="color:#666">.</span>download(snext, dnext)
            <span style="color:#007020;font-weight:bold">else</span>:
                self<span style="color:#666">.</span>long_running_items_left<span style="color:#666">.</span>inc()
                self<span style="color:#666">.</span>queue<span style="color:#666">.</span>put((self<span style="color:#666">.</span>sync_dir, [snext, dnext]))
        self<span style="color:#666">.</span>long_running_items_left<span style="color:#666">.</span>dec()

    <span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">download</span>(self, source, dest):
        <span style="color:#007020;font-weight:bold">print</span>(<span style="color:#4070a0">&#39;Downloading {0}&#39;</span><span style="color:#666">.</span>format(source))
        remote <span style="color:#666">=</span> RemoteFilesystem()
        remote<span style="color:#666">.</span>download_to(source, dest)</code></pre></div>
<p><strong>Link to github.</strong></p>

<p>Let&rsquo;s run this version and see how fast it works with 5 parallel workers:</p>

<pre><code>$ time python2 sync.py /home/bz/source dest
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
 Scanning dir /home/bz/source
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
 QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
 QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
Scanning dir /home/bz/source/banana
Scanning dir /home/bz/source/orange
Scanning dir /home/bz/source/apple
 QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
Downloading /home/bz/source/banana/_header
Downloading /home/bz/source/orange/_header
Downloading /home/bz/source/banana/_description
Scanning dir /home/bz/source/banana/2013-11-23
Downloading /home/bz/source/apple/_header
Downloading /home/bz/source/orange/_description
Downloading /home/bz/source/apple/_description
Scanning dir /home/bz/source/banana/2013-11-22
Scanning dir /home/bz/source/orange/2013-11-23
Scanning dir /home/bz/source/orange/2013-11-22
Scanning dir /home/bz/source/apple/2013-11-23
Downloading /home/bz/source/banana/2013-11-23/banana-2013-11-23-1.tsv.gz
Downloading /home/bz/source/banana/2013-11-22/banana-2013-11-22-0.tsv.gz
Downloading /home/bz/source/orange/2013-11-23/orange-2013-11-23-1.tsv.gz
Downloading /home/bz/source/banana/2013-11-23/banana-2013-11-23-0.tsv.gz
Downloading /home/bz/source/banana/2013-11-22/banana-2013-11-22-1.tsv.gz
Scanning dir /home/bz/source/apple/2013-11-22
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
Downloading /home/bz/source/orange/2013-11-23/orange-2013-11-23-0.tsv.gz
Downloading /home/bz/source/apple/2013-11-23/apple-2013-11-23-1.tsv.gz
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
Downloading /home/bz/source/orange/2013-11-22/orange-2013-11-22-1.tsv.gz
Downloading /home/bz/source/apple/2013-11-23/apple-2013-11-23-0.tsv.gz
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
Downloading /home/bz/source/orange/2013-11-22/orange-2013-11-22-0.tsv.gz
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
Downloading /home/bz/source/apple/2013-11-22/apple-2013-11-22-0.tsv.gz
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
Downloading /home/bz/source/apple/2013-11-22/apple-2013-11-22-1.tsv.gz
QUEUE IS EMPTY AND WE ARE DONE
QUEUE IS EMPTY AND WE ARE DONE
QUEUE IS EMPTY AND WE ARE DONE
QUEUE IS EMPTY AND WE ARE DONE
QUEUE IS EMPTY AND WE ARE DONE
python2 sync.py /home/bz/source dest  0.03s user 0.01s system 0% cpu 7.527 total
</code></pre>

<h3 id="less-variables">Less variables</h3>

<p>The very first thing that brings attention is this <code>transfer_done</code> variable. I
don&rsquo;t know what I was thinking but it is obvious that <code>long_running_items_left</code>
totally superseds it. Initializing <code>long_running_items_left</code> counter with value
1 and decrementing it before <code>join()</code> makes <code>transfer_done</code> completely useless.
This is the first thing to throw away.</p>

<p>The use of <code>long_running_items_left</code> variable does not seem right. It is used in
<code>sync_dir</code> method, while it is better to stick such variables to the worker
code. So instead, let&rsquo;s move <code>long_running_items_left</code> to the <code>sync_worker</code>
method. We will increment the value before the handler and decrement it after
the work is done.</p>

<p>Another thing to mention is explicit <code>time.sleep(1.0)</code> in <code>sync_worker</code>.
Instead, we can use blocking <code>Queue.get</code> and specify wait timeout. After that
we can safely remove <code>time.sleep</code> call. Here is a complete code:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">sync</span>(self, source, dest):
    self<span style="color:#666">.</span>queue <span style="color:#666">=</span> Queue<span style="color:#666">.</span>Queue()
    self<span style="color:#666">.</span>long_running_items_left <span style="color:#666">=</span> Counter(<span style="color:#40a070">1</span>)
    N <span style="color:#666">=</span> <span style="color:#40a070">5</span>

    <span style="color:#007020;font-weight:bold">for</span> i <span style="color:#007020;font-weight:bold">in</span> <span style="color:#007020">range</span>(N):
        t <span style="color:#666">=</span> threading<span style="color:#666">.</span>Thread(target<span style="color:#666">=</span>self<span style="color:#666">.</span>sync_worker)
        t<span style="color:#666">.</span>daemon <span style="color:#666">=</span> True
        t<span style="color:#666">.</span>start()

    self<span style="color:#666">.</span>sync_dir(source, dest)
    self<span style="color:#666">.</span>long_running_items_left<span style="color:#666">.</span>dec()

    <span style="color:#007020;font-weight:bold">while</span> threading<span style="color:#666">.</span>active_count() <span style="color:#666">&gt;</span> <span style="color:#40a070">1</span>:
        time<span style="color:#666">.</span>sleep(<span style="color:#40a070">0.1</span>)

    self<span style="color:#666">.</span>queue<span style="color:#666">.</span>join()

<span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">sync_worker</span>(self):
    <span style="color:#007020;font-weight:bold">while</span> True:
        <span style="color:#007020;font-weight:bold">try</span>:
            handler, args <span style="color:#666">=</span> self<span style="color:#666">.</span>queue<span style="color:#666">.</span>get(True, <span style="color:#40a070">1.0</span>)
            self<span style="color:#666">.</span>long_running_items_left<span style="color:#666">.</span>inc()
            handler(<span style="color:#666">*</span>args)
        <span style="color:#007020;font-weight:bold">except</span> Queue<span style="color:#666">.</span>Empty:
            <span style="color:#007020;font-weight:bold">if</span> self<span style="color:#666">.</span>long_running_items_left<span style="color:#666">.</span>value() <span style="color:#666">==</span> <span style="color:#40a070">0</span>:
                <span style="color:#007020;font-weight:bold">print</span>(<span style="color:#4070a0">&#39;QUEUE IS EMPTY AND WE ARE DONE&#39;</span>)
                <span style="color:#007020;font-weight:bold">return</span>
            <span style="color:#007020;font-weight:bold">else</span>:
                <span style="color:#007020;font-weight:bold">print</span>(<span style="color:#4070a0">&#39;QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING&#39;</span>)
                <span style="color:#007020;font-weight:bold">continue</span>
        <span style="color:#007020;font-weight:bold">except</span> <span style="color:#007020">Exception</span> <span style="color:#007020;font-weight:bold">as</span> e:
            <span style="color:#007020;font-weight:bold">print</span>(<span style="color:#4070a0">&#39;EXCEPTION IN WORKER: {0}&#39;</span><span style="color:#666">.</span>format(e))
        self<span style="color:#666">.</span>long_running_items_left<span style="color:#666">.</span>dec()
        self<span style="color:#666">.</span>queue<span style="color:#666">.</span>task_done()

<span style="color:#007020;font-weight:bold">def</span> <span style="color:#06287e">sync_dir</span>(self, source, dest):
    <span style="color:#007020;font-weight:bold">print</span>(<span style="color:#4070a0">&#39;Scanning dir {0}&#39;</span><span style="color:#666">.</span>format(source))
    remote <span style="color:#666">=</span> RemoteFilesystem()
    files <span style="color:#666">=</span> remote<span style="color:#666">.</span><span style="color:#007020">list</span>(source)
    <span style="color:#007020;font-weight:bold">for</span> x <span style="color:#007020;font-weight:bold">in</span> files:
        snext, dnext <span style="color:#666">=</span> J(source, x<span style="color:#666">.</span>name), J(dest, x<span style="color:#666">.</span>name)
        <span style="color:#007020;font-weight:bold">if</span> x<span style="color:#666">.</span>filetype <span style="color:#666">==</span> <span style="color:#4070a0">&#39;file&#39;</span>:
            self<span style="color:#666">.</span>download(snext, dnext)
        <span style="color:#007020;font-weight:bold">else</span>:
            self<span style="color:#666">.</span>queue<span style="color:#666">.</span>put((self<span style="color:#666">.</span>sync_dir, [snext, dnext]))</code></pre></div>
<p><strong>Link to github.</strong></p>

<h3 id="poison-pill">Poison pill</h3>

<p>This looks a little better: we narrowed down the use of
<code>long_running_items_left</code>, removed unnecessary <code>transfer_done</code> and got rid of
explicit <code>time.sleep</code>. However, there is a problem with this approach. It&rsquo;s
hidden in this pair of lines:</p>
<div class="highlight"><pre style="background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">handler, args <span style="color:#666">=</span> self<span style="color:#666">.</span>queue<span style="color:#666">.</span>get(True, <span style="color:#40a070">1.0</span>)
self<span style="color:#666">.</span>long_running_items_left<span style="color:#666">.</span>inc()</code></pre></div>
<p>The problem with this code is that we use two different synchronization mechanisms
simultaneously and it&rsquo;s not atomic. <em>JUSTIFY NON-ATOMICITY, GIVE MORE EXAMPLES</em>.</p>

<p>Can we do better? Yes we can if we recall &ldquo;poison pill&rdquo; technique. The trick
is, instead of busy waiting in the worker, to send the worker a special
message. When worker receives such a message, it means there&rsquo;s no more work to
do here and it quits.</p>

      
    </div>
    
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p></p>
    
  </div>
</section>

</body>
</html>

