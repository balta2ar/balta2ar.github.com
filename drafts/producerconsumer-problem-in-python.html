<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>“Producer/Consumer problem in python”</title>
        <link rel="stylesheet" href="http://balta2ar.github.io/theme/css/main.css" />
        <link href="http://balta2ar.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Mostly Technical Atom Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://balta2ar.github.io/">Mostly Technical </a></h1>
                <nav><ul>
                    <li class="active"><a href="http://balta2ar.github.io/category/misc.html">misc</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://balta2ar.github.io/drafts/producerconsumer-problem-in-python.html" rel="bookmark"
           title="Permalink to “Producer/Consumer problem in python”"><span class="dquo">&#8220;</span>Producer/Consumer problem in&nbsp;python&#8221;</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <span>Sat 23 November 2013</span>

</footer><!-- /.post-info -->      <p>Recently I stumbled upon an almost classical <a href="http://en.wikipedia.org/wiki/Producer%E2%80%93consumer_problem">producer-consumer
problem</a> in my script. The script is very similar to the
popular <a href="http://s3tools.org/s3cmd">s3cmd</a> &#8212; it syncronises contents of the local and remote
folder. Direction doesn&#8217;t matter but for the clarity let&#8217;s pretend it downloads
data from the remote&nbsp;side.</p>
<!--
Recently I stumbled upon an almost classical [producer-consumer
problem][producer-consumer] in my script. The script is very similar to the
popular [s3cmd][s3cmd] - it syncronises contents of the local and [S3][s3]
folder. Direction doesn't matter but for the clarity let's pretend it downloads
data from S3. Of course I could take s3cmd from an [alternative][s3cmdparallel1]
[github][s3cmdparallel2] repo where parallel workers feature is already
implemented (there is an [issue][issue] in s3cmd to implement that). However,
for some reason, I needed my very own version of such parallel downloader.
-->

<!-- more -->

<p>In this post I would like to tell a story of my progress implementing this
feature, share some bugs I found and workarounds I had to use. First, let me
describe the directory structure. It is rather strict and looks like&nbsp;this:</p>
<div class="highlight"><pre><span></span>$ tree /home/bz/source 
/home/bz/source
├── apple
│   ├── <span class="m">2013</span>-11-22
│   │   ├── apple-2013-11-22-0.tsv.gz
│   │   └── apple-2013-11-22-1.tsv.gz
│   ├── <span class="m">2013</span>-11-23
│   │   ├── apple-2013-11-23-0.tsv.gz
│   │   └── apple-2013-11-23-1.tsv.gz
│   ├── _description
│   └── _header
├── banana
│   ├── <span class="m">2013</span>-11-22
│   │   ├── banana-2013-11-22-0.tsv.gz
│   │   └── banana-2013-11-22-1.tsv.gz
│   ├── <span class="m">2013</span>-11-23
│   │   ├── banana-2013-11-23-0.tsv.gz
│   │   └── banana-2013-11-23-1.tsv.gz
│   ├── _description
│   └── _header
└── orange
    ├── <span class="m">2013</span>-11-22
    │   ├── orange-2013-11-22-0.tsv.gz
    │   └── orange-2013-11-22-1.tsv.gz
    ├── <span class="m">2013</span>-11-23
    │   ├── orange-2013-11-23-0.tsv.gz
    │   └── orange-2013-11-23-1.tsv.gz
    ├── _description
    └── _header

<span class="m">9</span> directories, <span class="m">18</span> files
</pre></div>


<h3>First&nbsp;try</h3>
<p>Let&#8217;s start with a very basic non-parallel sketch of such downloader. I will
use python2 because of the dependencies I have in my original&nbsp;script.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">J</span>


<span class="k">def</span> <span class="nf">delay</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">wait</span> <span class="o">=</span> <span class="n">ms</span> <span class="o">+</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">RemoteFilesystem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">File</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filetype</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="n">filetype</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;{0}_{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="s1">&#39;file&#39;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="k">else</span> <span class="s1">&#39;dir&#39;</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RemoteFilesystem</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">typ</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">items</span>

    <span class="k">def</span> <span class="nf">download_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Downloading {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
        <span class="n">delay</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dest</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fdest</span><span class="p">:</span>
            <span class="n">fdest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Scanning dir {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
    <span class="n">remote</span> <span class="o">=</span> <span class="n">RemoteFilesystem</span><span class="p">()</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">remote</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">snext</span><span class="p">,</span> <span class="n">dnext</span> <span class="o">=</span> <span class="n">J</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">J</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
            <span class="n">remote</span><span class="o">.</span><span class="n">download_to</span><span class="p">(</span><span class="n">snext</span><span class="p">,</span> <span class="n">dnext</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sync</span><span class="p">(</span><span class="n">snext</span><span class="p">,</span> <span class="n">dnext</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">source</span><span class="p">,</span> <span class="n">dest</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">sync</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>


<p><strong>Link to&nbsp;github.</strong></p>
<p>I intentionally keep the number of error checks at minimum to not to distract
you with non-related details. To simulate delays (connection establishment, data
transfer) in the original remote system I added artificial random delays. Let&#8217;s
run our script and see how fast it&nbsp;works:</p>
<div class="highlight"><pre><span></span>$ <span class="nb">time</span> python2 sync.py /home/bz/source dest
Scanning dir /home/bz/source
Scanning dir /home/bz/source/banana
Downloading /home/bz/source/banana/_header
Downloading /home/bz/source/banana/_description
Scanning dir /home/bz/source/banana/2013-11-23
Downloading /home/bz/source/banana/2013-11-23/banana-2013-11-23-1.tsv.gz
Downloading /home/bz/source/banana/2013-11-23/banana-2013-11-23-0.tsv.gz
Scanning dir /home/bz/source/banana/2013-11-22
Downloading /home/bz/source/banana/2013-11-22/banana-2013-11-22-0.tsv.gz
Downloading /home/bz/source/banana/2013-11-22/banana-2013-11-22-1.tsv.gz
Scanning dir /home/bz/source/orange
Downloading /home/bz/source/orange/_header
Downloading /home/bz/source/orange/_description
Scanning dir /home/bz/source/orange/2013-11-23
Downloading /home/bz/source/orange/2013-11-23/orange-2013-11-23-1.tsv.gz
Downloading /home/bz/source/orange/2013-11-23/orange-2013-11-23-0.tsv.gz
Scanning dir /home/bz/source/orange/2013-11-22
Downloading /home/bz/source/orange/2013-11-22/orange-2013-11-22-1.tsv.gz
Downloading /home/bz/source/orange/2013-11-22/orange-2013-11-22-0.tsv.gz
Scanning dir /home/bz/source/apple
Downloading /home/bz/source/apple/_header
Downloading /home/bz/source/apple/_description
Scanning dir /home/bz/source/apple/2013-11-23
Downloading /home/bz/source/apple/2013-11-23/apple-2013-11-23-1.tsv.gz
Downloading /home/bz/source/apple/2013-11-23/apple-2013-11-23-0.tsv.gz
Scanning dir /home/bz/source/apple/2013-11-22
Downloading /home/bz/source/apple/2013-11-22/apple-2013-11-22-0.tsv.gz
Downloading /home/bz/source/apple/2013-11-22/apple-2013-11-22-1.tsv.gz
python2 sync.py /home/bz/source dest  <span class="m">0</span>.02s user <span class="m">0</span>.02s system <span class="m">0</span>% cpu <span class="m">16</span>.172 total
</pre></div>


<p>Not very fast indeed. We definitely can reduce total running time if we run the
sync in parallel. In my first try I decided to use thread-safe Queue module.  My
idea was to run directory listing in workers instead of the main thread. To do
this, instead of listing the directory immediately I put listing request into
the queue. I quickly realized that this model is not quite a traditionally
explained producer-consumer model. In a classic producer-consumer model
producers and consumers are different entities (even though there might be many
of each). This means that producer will never consume an item and vise versa.
In my case, however, it was not&nbsp;true.</p>
<p>When another directory is listed, it might return a list of files which will be
downloaded in the same thread. However it might also return a list of
subdirectories which will be added to the queue to scan later, possibly in a
different worker. Thus, the very first method which starts the syncronization
doesn&#8217;t really know in advance what files and directories there will be and it
doesn&#8217;t know when to stop processing. In my case consumer can produce more work
and we don&#8217;t know if it happens in&nbsp;advance.</p>
<h3>Parallel&nbsp;try</h3>
<p>Here is a new parallel version startup method. It creates a <code>queue</code>,
<code>long_running_items_left</code> counter of the currently running directory listings and a
global signal <code>transfer_done</code>:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">transfer_done</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">long_running_items_left</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_worker</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">sync_dir</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">transfer_done</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">threading</span><span class="o">.</span><span class="n">active_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>


<p>As you can see, <code>join()</code> is not used to wait for the queue to drain. Instead,
<code>threading.active_count()</code> is used to check the number currently running
threads. First time I saw this hack in s3cmd <a href="https://github.com/pcorliss/s3cmd-modification/commit/9a65f78ea9e2a6633558a9462dc285c9ce1d943a#diff-c2214fd9d0677e2abe4e25e9a8950a2cR72">parallel</a>
patch. It&nbsp;says:</p>
<div class="highlight"><pre><span></span>    <span class="c1">#Necessary to ensure KeyboardInterrupt can actually kill</span>
    <span class="c1">#Otherwise Queue.join() blocks until all queue elements have completed</span>
    <span class="k">while</span> <span class="n">threading</span><span class="o">.</span><span class="n">active_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<p>I didn&#8217;t know at the moment why it was necessary and why would <code>join()</code> ignore
<code>KeyboardInterrupt</code> so I just copy-pasted it. Because of this hacky way to join
we now need to make sure that workers know when to die. In my case they need
to busy-loop waiting for the queue to fill with something and when they know
for sure that there will be no more work, worker should&nbsp;terminate.</p>
<p>This appeared to be tricky. How does a worker know when to terminate? To give
worker this knowledge, I introduced two new&nbsp;variables:</p>
<div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">transfer_done</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
<span class="bp">self</span><span class="o">.</span><span class="n">long_running_items_left</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<p><code>transfer_done</code> is a global event. It is cleared before the first call to
<code>sync_dir</code> and it is set before waiting for the number of active threads to go
down to&nbsp;one.</p>
<p><code>long_running_items_left</code> is a thread-safe counter. It is incemented
before <code>list_dir</code> and is decremented when <code>list_dir</code> is done. This counter
represents the number currently listing directories. The need for such counter
can be demonstrated in an example: suppose we&#8217;re running 10 workers. We list
the first directory and a list of three subdirectories is returned. Three items
are added to the queue and they all are soon taken by three different workers.
However, the rest of the workers, seven of them, they try to get work from the
queue but it&#8217;s empty. The worker can&#8217;t tell if it&#8217;s <span class="caps">OK</span> to die only by observing
the queue. We know that at the very moment there are three other workers
listing some directories and we need to provide this information to other
workers so that they don&#8217;t terminate&nbsp;prematurely.</p>
<p>Also, because <code>sync_dir</code> is called in the startup method, the counter is
initialized with value&nbsp;1:</p>
<div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">long_running_items_left</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<p><code>Counter</code> is a simple thread-safe counter guarded with <code>threading.Lock</code>. I
couldn&#8217;t find anything similar in the <code>threading</code> module so I invented my&nbsp;own:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Counter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initval</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">initval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">inc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">+=</span> <span class="n">n</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span>

    <span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">-=</span> <span class="n">n</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span>

    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span>
</pre></div>


<p>Now when <code>sync_dir</code> sees another directory it will enqueue it instead of
immediate&nbsp;listing:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sync_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Scanning dir {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
    <span class="n">remote</span> <span class="o">=</span> <span class="n">RemoteFilesystem</span><span class="p">()</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">remote</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">snext</span><span class="p">,</span> <span class="n">dnext</span> <span class="o">=</span> <span class="n">J</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">J</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">snext</span><span class="p">,</span> <span class="n">dnext</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">long_running_items_left</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_dir</span><span class="p">,</span> <span class="p">[</span><span class="n">snext</span><span class="p">,</span> <span class="n">dnext</span><span class="p">]))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">long_running_items_left</span><span class="o">.</span><span class="n">dec</span><span class="p">()</span>
</pre></div>


<p><code>sync_worker</code> is executed by every worker. In this method we request another
piece of work from the queue and try to process it. As I mentioned before,
empty queue doesn&#8217;t necessarily mean we can terminate. That&#8217;s why we also
check <code>transfer_done</code> and <code>long_running_items_left</code>. If we extracted and successfully
processed a work, we mark task as&nbsp;done.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sync_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">handler</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
            <span class="n">handler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_done</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_running_items_left</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;QUEUE IS EMPTY AND WE ARE DONE&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING&#39;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;EXCEPTION IN WORKER: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
</pre></div>


<p>Here is a complete code in one piece (I also restructured the code a bit, moved
all syncer methods into the same&nbsp;class):</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Counter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initval</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">initval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">inc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">+=</span> <span class="n">n</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span>

    <span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">-=</span> <span class="n">n</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span>

    <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span>


<span class="k">class</span> <span class="nc">Syncer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_done</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_running_items_left</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_worker</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sync_dir</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_done</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">threading</span><span class="o">.</span><span class="n">active_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">sync_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">handler</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                <span class="n">handler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_done</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">long_running_items_left</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;QUEUE IS EMPTY AND WE ARE DONE&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING&#39;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;EXCEPTION IN WORKER: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">sync_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Scanning dir {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
        <span class="n">remote</span> <span class="o">=</span> <span class="n">RemoteFilesystem</span><span class="p">()</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">remote</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">snext</span><span class="p">,</span> <span class="n">dnext</span> <span class="o">=</span> <span class="n">J</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">J</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">snext</span><span class="p">,</span> <span class="n">dnext</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">long_running_items_left</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_dir</span><span class="p">,</span> <span class="p">[</span><span class="n">snext</span><span class="p">,</span> <span class="n">dnext</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_running_items_left</span><span class="o">.</span><span class="n">dec</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Downloading {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
        <span class="n">remote</span> <span class="o">=</span> <span class="n">RemoteFilesystem</span><span class="p">()</span>
        <span class="n">remote</span><span class="o">.</span><span class="n">download_to</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
</pre></div>


<p><strong>Link to&nbsp;github.</strong></p>
<p>Let&#8217;s run this version and see how fast it works with 5 parallel&nbsp;workers:</p>
<div class="highlight"><pre><span></span>$ <span class="nb">time</span> python2 sync.py /home/bz/source dest
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
 Scanning dir /home/bz/source
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
 QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
 QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
Scanning dir /home/bz/source/banana
Scanning dir /home/bz/source/orange
Scanning dir /home/bz/source/apple
 QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
Downloading /home/bz/source/banana/_header
Downloading /home/bz/source/orange/_header
Downloading /home/bz/source/banana/_description
Scanning dir /home/bz/source/banana/2013-11-23
Downloading /home/bz/source/apple/_header
Downloading /home/bz/source/orange/_description
Downloading /home/bz/source/apple/_description
Scanning dir /home/bz/source/banana/2013-11-22
Scanning dir /home/bz/source/orange/2013-11-23
Scanning dir /home/bz/source/orange/2013-11-22
Scanning dir /home/bz/source/apple/2013-11-23
Downloading /home/bz/source/banana/2013-11-23/banana-2013-11-23-1.tsv.gz
Downloading /home/bz/source/banana/2013-11-22/banana-2013-11-22-0.tsv.gz
Downloading /home/bz/source/orange/2013-11-23/orange-2013-11-23-1.tsv.gz
Downloading /home/bz/source/banana/2013-11-23/banana-2013-11-23-0.tsv.gz
Downloading /home/bz/source/banana/2013-11-22/banana-2013-11-22-1.tsv.gz
Scanning dir /home/bz/source/apple/2013-11-22
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
Downloading /home/bz/source/orange/2013-11-23/orange-2013-11-23-0.tsv.gz
Downloading /home/bz/source/apple/2013-11-23/apple-2013-11-23-1.tsv.gz
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
Downloading /home/bz/source/orange/2013-11-22/orange-2013-11-22-1.tsv.gz
Downloading /home/bz/source/apple/2013-11-23/apple-2013-11-23-0.tsv.gz
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
Downloading /home/bz/source/orange/2013-11-22/orange-2013-11-22-0.tsv.gz
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
Downloading /home/bz/source/apple/2013-11-22/apple-2013-11-22-0.tsv.gz
QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING
Downloading /home/bz/source/apple/2013-11-22/apple-2013-11-22-1.tsv.gz
QUEUE IS EMPTY AND WE ARE DONE
QUEUE IS EMPTY AND WE ARE DONE
QUEUE IS EMPTY AND WE ARE DONE
QUEUE IS EMPTY AND WE ARE DONE
QUEUE IS EMPTY AND WE ARE DONE
python2 sync.py /home/bz/source dest  <span class="m">0</span>.03s user <span class="m">0</span>.01s system <span class="m">0</span>% cpu <span class="m">7</span>.527 total
</pre></div>


<h3>Less&nbsp;variables</h3>
<p>The very first thing that brings attention is this <code>transfer_done</code> variable. I
don&#8217;t know what I was thinking but it is obvious that <code>long_running_items_left</code>
totally superseds it. Initializing <code>long_running_items_left</code> counter with value
1 and decrementing it before <code>join()</code> makes <code>transfer_done</code> completely useless.
This is the first thing to throw&nbsp;away.</p>
<p>The use of <code>long_running_items_left</code> variable does not seem right. It is used in
<code>sync_dir</code> method, while it is better to stick such variables to the worker
code. So instead, let&#8217;s move <code>long_running_items_left</code> to the <code>sync_worker</code>
method. We will increment the value before the handler and decrement it after
the work is&nbsp;done.</p>
<p>Another thing to mention is explicit <code>time.sleep(1.0)</code> in <code>sync_worker</code>.
Instead, we can use blocking <code>Queue.get</code> and specify wait timeout. After that
we can safely remove <code>time.sleep</code> call. Here is a complete&nbsp;code:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">long_running_items_left</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_worker</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">sync_dir</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">long_running_items_left</span><span class="o">.</span><span class="n">dec</span><span class="p">()</span>

    <span class="k">while</span> <span class="n">threading</span><span class="o">.</span><span class="n">active_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">sync_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">handler</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">long_running_items_left</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
            <span class="n">handler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_running_items_left</span><span class="o">.</span><span class="n">value</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;QUEUE IS EMPTY AND WE ARE DONE&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;QUEUE IS EMPTY BUT WE ARE NOT DONE, SLEEPING&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;EXCEPTION IN WORKER: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_running_items_left</span><span class="o">.</span><span class="n">dec</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">sync_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Scanning dir {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
    <span class="n">remote</span> <span class="o">=</span> <span class="n">RemoteFilesystem</span><span class="p">()</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">remote</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">snext</span><span class="p">,</span> <span class="n">dnext</span> <span class="o">=</span> <span class="n">J</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">J</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">snext</span><span class="p">,</span> <span class="n">dnext</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_dir</span><span class="p">,</span> <span class="p">[</span><span class="n">snext</span><span class="p">,</span> <span class="n">dnext</span><span class="p">]))</span>
</pre></div>


<p><strong>Link to&nbsp;github.</strong></p>
<h3>Poison&nbsp;pill</h3>
<p>This looks a little better: we narrowed down the use of
<code>long_running_items_left</code>, removed unnecessary <code>transfer_done</code> and got rid of
explicit <code>time.sleep</code>. However, there is a problem with this approach. It&#8217;s
hidden in this pair of&nbsp;lines:</p>
<div class="highlight"><pre><span></span><span class="n">handler</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">long_running_items_left</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>
</pre></div>


<p>The problem with this code is that we use two different synchronization mechanisms
simultaneously and it&#8217;s not atomic. <em><span class="caps">JUSTIFY</span> <span class="caps">NON</span>-<span class="caps">ATOMICITY</span>, <span class="caps">GIVE</span> <span class="caps">MORE</span> <span class="caps">EXAMPLES</span></em>.</p>
<p>Can we do better? Yes we can if we recall &#8220;poison pill&#8221; technique. The trick
is, instead of busy waiting in the worker, to send the worker a special
message. When worker receives such a message, it means there&#8217;s no more work to
do here and it&nbsp;quits.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://balta2ar.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

</body>
</html>