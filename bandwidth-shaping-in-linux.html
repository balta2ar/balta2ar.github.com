<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>“Bandwidth shaping in Linux”</title>
        <link rel="stylesheet" href="http://balta2ar.github.io/theme/css/main.css" />
        <link href="http://balta2ar.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Mostly Technical Atom Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://balta2ar.github.io/">Mostly Technical </a></h1>
                <nav><ul>
                    <li class="active"><a href="http://balta2ar.github.io/category/misc.html">misc</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://balta2ar.github.io/bandwidth-shaping-in-linux.html" rel="bookmark"
           title="Permalink to “Bandwidth shaping in Linux”"><span class="dquo">&#8220;</span>Bandwidth shaping in&nbsp;Linux&#8221;</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <span>Sat 23 November 2013</span>

</footer><!-- /.post-info -->      <p>It&#8217;s always been a problem for me to shape traffic in Linux. After Windows
experience with Outpost firewall I couldn&#8217;t find an easy and convenient way
to shape traffic in Linux. Judging by the amount of similar questions over
the Internet it&#8217;s unobvious not only to me but to many other&nbsp;users.</p>
<!-- more -->

<p>It appears there are different ways to achieve that in Linux. I personally found
two of them useful: <a href="http://monkey.org/~marius/pages/?page=trickle">trickle</a> and <a href="http://tldp.org/HOWTO/Traffic-Control-HOWTO/intro.html">tc</a>.</p>
<h2>trickle</h2>
<p><code>trickle</code> is simple and easy to use, just run the program you want to limit
and specify the&nbsp;bandwith:</p>
<div class="highlight"><pre><span></span>$ trickle -d 20kb wget http://mirror.rol.ru/archlinux/iso/2013.11.01/archlinux-2013.11.01-dual.iso
trickle: Could not reach trickled, working independently: No such file or directory
--2013-11-23 <span class="m">17</span>:09:37--  http://mirror.rol.ru/archlinux/iso/2013.11.01/archlinux-2013.11.01-dual.iso
Resolving mirror.rol.ru <span class="o">(</span>mirror.rol.ru<span class="o">)</span>... <span class="m">194</span>.67.1.114
Connecting to mirror.rol.ru <span class="o">(</span>mirror.rol.ru<span class="o">)</span><span class="p">|</span><span class="m">194</span>.67.1.114<span class="p">|</span>:80... connected.
HTTP request sent, awaiting response... <span class="m">200</span> OK
Length: <span class="m">541065216</span> <span class="o">(</span>516M<span class="o">)</span> <span class="o">[</span>application/octet-stream<span class="o">]</span>
Saving to: ‘archlinux-2013.11.01-dual.iso’

 <span class="m">0</span>% <span class="o">[</span>                                                                                      <span class="o">]</span> <span class="m">144</span>,540     <span class="m">20</span>.0KB/s  eta 5h 53m
</pre></div>


<p><code>trickle</code> works in userspace. It takes advantage of the unix loader preloading
functionality to intercept <code>read</code>/<code>write</code> calls. See the <a href="http://monkey.org/~marius/trickle/trickle.pdf">paper</a> for the&nbsp;details.</p>
<h2>tc</h2>
<p>tc is a different beast. It&#8217;s quite a complex thing for a newbie like me though
it&#8217;s powerful. tc allows you to create intricate rules to shape your traffic.
The problem is that only outgoing traffic can be shaped in a graceful way. In
incoming traffic you can only brutally drop&nbsp;packets.</p>
<p>This is nasty but luckily there is a way around called <a href="http://www.linuxfoundation.org/collaborate/workgroups/networking/ifb">The Intermediate
Functional Block device</a>. With this module you can reroute incoming traffic
from ifb device to eth0 so that the traffic will be treated as outgoing when
leaving&nbsp;ifb.</p>
<p>I should&#8217;ve propably taken a weekend to dig really deep into tc functionality
and master it but instead I went the easy way. After googling for a while I
found this brilliant question/answer and this&nbsp;script:</p>
<ul>
<li><a href="http://serverfault.com/questions/350023/tc-ingress-policing-and-ifb-mirroring">Tc: ingress policing and ifb&nbsp;mirroring</a></li>
<li><a href="https://github.com/rfrail3/misc/blob/master/tc/traffic-control.sh">traffic-control.sh</a></li>
</ul>
<p>Inspired by this two wonderful sources I came up with my own&nbsp;version:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="c1">#</span>
<span class="c1"># $1 -- incoming bandwidth</span>
<span class="c1"># $2 -- outgoing bandwidth</span>
<span class="c1">#</span>
<span class="c1"># bandwidth.sh init -- modprobe &amp;&amp; ip up</span>
<span class="c1"># bandwidth.sh x y  -- set incoming bandwidth to x, outgoing to y</span>
<span class="c1"># bandwidth.sh      -- remove limits</span>
<span class="c1"># bandwidth.sh - y  -- remove incoming limits, set outgoing limit</span>
<span class="c1">#</span>

<span class="c1"># init</span>
<span class="c1"># modprobe ifb numifbs=1</span>
<span class="c1"># ip link set dev ifb0 up # repeat for ifb1, ifb2, ...</span>

<span class="nv">PHY</span><span class="o">=</span>eth0
<span class="nv">VIR</span><span class="o">=</span>ifb0
<span class="nv">IN</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">OUT</span><span class="o">=</span><span class="nv">$2</span>

<span class="k">function</span> go<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$*</span><span class="s2">&quot;</span>
    <span class="nb">eval</span> <span class="s2">&quot;</span><span class="nv">$*</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="nv">$?</span>
<span class="o">}</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$#</span> -eq <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">==</span> <span class="s2">&quot;init&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;Initializing&quot;</span>
        go modprobe ifb <span class="nv">numifbs</span><span class="o">=</span><span class="m">1</span>
        go ip link <span class="nb">set</span> dev ifb0 up
        <span class="nb">exit</span> <span class="m">0</span>
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$IN</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">IN</span><span class="o">=</span>
<span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$OUT</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">OUT</span><span class="o">=</span>

go tc qdisc del dev <span class="nv">$PHY</span> root       <span class="c1"># clear outgoing</span>
go tc qdisc del dev <span class="nv">$PHY</span> ingress    <span class="c1"># clear incoming</span>
go tc qdisc del dev <span class="nv">$VIR</span> root       <span class="c1"># clean incoming</span>

<span class="o">[</span> <span class="nv">$#</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">exit</span> <span class="m">0</span>

go tc qdisc add dev <span class="nv">$PHY</span> handle ffff: ingress
go tc filter add dev <span class="nv">$PHY</span> parent ffff: protocol ip u32 match u32 <span class="m">0</span> <span class="m">0</span> action mirred egress redirect dev ifb0

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$IN</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c1"># incoming</span>
    go tc qdisc add dev <span class="nv">$VIR</span> root handle <span class="m">1</span>: htb default <span class="m">10</span>
    go tc class add dev <span class="nv">$VIR</span> parent <span class="m">1</span>: classid <span class="m">1</span>:1 htb rate <span class="nv">$IN</span>
    go tc class add dev <span class="nv">$VIR</span> parent <span class="m">1</span>:1 classid <span class="m">1</span>:10 htb rate <span class="nv">$IN</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$OUT</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c1"># outgoing</span>
    go tc qdisc add dev <span class="nv">$PHY</span> root handle <span class="m">1</span>: htb default <span class="m">10</span>
    go tc class add dev <span class="nv">$PHY</span> parent <span class="m">1</span>: classid <span class="m">1</span>:1 htb rate <span class="nv">$OUT</span>
    go tc class add dev <span class="nv">$PHY</span> parent <span class="m">1</span>:1 classid <span class="m">1</span>:10 htb rate <span class="nv">$OUT</span>
<span class="k">fi</span>
</pre></div>


<p>You can also get the script <a href="https://gist.github.com/balta2ar/7614370">here</a>. Now traffic shaping is a matter of
a couple of&nbsp;calls:</p>
<div class="highlight"><pre><span></span>sudo bandwidth.sh init          <span class="c1"># load ifb kernel module</span>
sudo bandwidth.sh 100kbps       <span class="c1"># set incoming limit</span>
sudo bandwidth.sh - 200kbps     <span class="c1"># remove incoming limit, set outgoing limit</span>
sudo bandwidth.sh 10kbps 20kbps <span class="c1"># set both incoming &amp; outgoing limits</span>
</pre></div>


<p>The only thing that I miss now is shaping traffic for each process individually
and changing limits on the&nbsp;fly.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://balta2ar.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

</body>
</html>